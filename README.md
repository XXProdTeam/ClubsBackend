# ClubsBackend

Бэкенд-приложение для мини-приложения "Клубы" в мессенджере MAX.

## Оглавление
- [Необходимые компоненты](#необходимые-компоненты)
- [Конфигурация](#конфигурация)
- [Запуск](#запуск)
  - [Локальный запуск для разработки](#локальный-запуск-для-разработки)
  - [Запуск в продакшене](#запуск-в-продакшене)
- [Доступные команды Makefile](#доступные-команды-makefile)

## Необходимые компоненты
Перед началом работы убедитесь, что на вашем компьютере установлены следующие компоненты:
- [Docker](https://www.docker.com/get-started)
- [Docker Compose](https://docs.docker.com/compose/install/)

## Конфигурация
Для корректной работы приложения необходимо создать файл `.env` в корневой директории проекта. Этот файл должен содержать следующие переменные окружения:

```env
POSTGRES_USER=your_postgres_user
POSTGRES_PASSWORD=your_postgres_password
POSTGRES_DB=your_postgres_db
POSTGRES_HOST=db
POSTGRES_PORT=5432

BOT_TOKEN=your_bot_token
```

Замените `your_postgres_user`, `your_postgres_password`, `your_postgres_db` и `your_bot_token` на ваши значения.

**Важно:** Для работы в Docker используйте `POSTGRES_HOST=db`. Для локальной разработки измените на `POSTGRES_HOST=localhost`.

## Запуск
Проект можно запустить в двух режимах: для локальной разработки и для продакшена.

### Локальный запуск для разработки
Этот режим запускает основные сервисы: `app`, `bot` и `db`.

1.  **Сборка и запуск контейнеров:**
    Для сборки и запуска контейнеров в фоновом режиме выполните следующую команду в терминале:

    ```bash
    make up-dev
    ```
    Эта команда использует файл `docker-compose.yml` для сборки и запуска необходимых сервисов.

2.  **Проверка состояния:**
    Вы можете проверить состояние запущенных контейнеров с помощью команды:
    ```bash
    docker compose ps
    ```

3.  **Остановка контейнеров:**
    Чтобы остановить все запущенные контейнеры, используйте команду:
    ```bash
    make down
    ```

### Запуск в продакшене
В этом режиме дополнительно запускаются `nginx` для обратного проксирования и `certbot` для автоматического получения и обновления SSL-сертификатов.

1.  **Сборка и запуск контейнеров:**
    Для сборки и запуска всех сервисов в продакшен-режиме выполните:
    ```bash
    make up
    ```
    Эта команда использует файлы `docker-compose.yml` и `docker-compose.prod.yml` для создания полной продакшен-среды. Контейнеры будут запущены в фоновом режиме.

2.  **Пример запуска через командную строку:**
    Если вы хотите запустить проект без использования `Makefile`, вы можете выполнить следующую команду напрямую:
    ```bash
    docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
    ```

3.  **Остановка контейнеров:**
    Для остановки всех сервисов, запущенных в продакшен-режиме, используйте:
    ```bash
    make down
    ```
    Или, если требуются права суперпользователя:
    ```bash
    make down-tot
    ```

## Доступные команды Makefile
В `Makefile` определены следующие команды для удобства управления проектом:

-   `make help`: Показывает все доступные команды.
-   `make up`: Собирает и запускает все продакшен-сервисы в фоновом режиме (с nginx и certbot).
-   `make up-dev`: Запускает сервисы для локальной разработки (без nginx и certbot).
-   `make up-at`: Собирает и запускает все продакшен-сервисы в интерактивном режиме (полезно для отладки).
-   `make down`: Останавливает все сервисы.
-   `make down-tot`: Останавливает все сервисы с правами суперпользователя.

## Доступ к приложению

После запуска сервисов приложение будет доступно по следующим адресам:

- **API Documentation (Swagger)**: http://localhost:8000/docs
- **Health Check**: http://localhost:8000/status

## Дополнительные команды

### Просмотр логов
```bash
# Все сервисы
docker compose logs -f

# Конкретный сервис
docker compose logs -f app
docker compose logs -f bot
docker compose logs -f db
```

### Остановка с удалением данных
```bash
# ВНИМАНИЕ: удаляет все данные БД
docker compose down -v
```
